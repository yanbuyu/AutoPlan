name: autoBuild

on: 
  repository_dispatch:
  workflow_dispatch:

# 定时触发编译
  schedule:
    - cron: 0 2,10,18 * * *

# 点赞☆Star触发编译
#  watch:
#    types: [started]

jobs:
  autoBuild:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
    - name: Clone Repository
      uses: actions/checkout@v2

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo timedatectl set-timezone "Asia/Shanghai"
        sudo apt update
        sudo apt --fix-broken install
        sudo apt install -y openjdk-17-jdk python3 python3-pip curl wget p7zip p7zip-full aria2 git
        sudo update-alternatives --install /usr/bin/python python /usr/bin/python3 1
        sudo update-alternatives --install /usr/bin/pip pip /usr/bin/pip3 1
        sudo pip install protobuf==3.20.0
        #lanzou-api
        sudo pip install requests_toolbelt
        sudo pip install lxml click asn1crypto Beautifulsoup4 requests xmltodict dicttoxml jsonpath colorama filetype chardet aligo protobuf cryptography pyOpenSSL certifi
        git clone https://${{ secrets._GITHUB_PERSONAL_NAME }}:${{ secrets._GITHUB_PERSONAL_TOKEN }}@github.com/${{ secrets._GITHUB_PERSONAL_NAME }}/${{ secrets._GITHUB_PERSONAL_REPO }}.git
        cd ${{ secrets._GITHUB_PERSONAL_REPO }}
        touch ./passWord.txt
        echo "${{ secrets._GITHUB_ALI_TOKEN }}" >./aliCloudToken.txt
        echo "${{ secrets._GITHUB_LANZOU_COOKIES_START }}" >./lanzouCloudCookies.txt
        echo "${{ secrets._GITHUB_LANZOU_COOKIES_END }}" >>./lanzouCloudCookies.txt
        python ./pyscript/toolpy/config.py

    - name: Delete workflow runs
      uses: GitRML/delete-workflow-runs@main
      continue-on-error: true
      with:
        retain_days: 3
        keep_minimum_runs: 0

    - name: add framework-res
      run: |
        cd ${{ secrets._GITHUB_PERSONAL_REPO }}
        mkdir -p ./framework
        cp -af ./framework-res/*.apk ./framework

    - name: autoBuild
      run: |
        cd ${{ secrets._GITHUB_PERSONAL_REPO }}
        sudo python ./pyscript/mainpy/autoBuild.py

    #- name: Upload Apps
    #  uses: actions/upload-artifact@main
    #  with:
    #    name: MIUIApps
    #    path: out/*.apk
